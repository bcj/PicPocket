<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <link rel="stylesheet" type="text/css" href="/style.css" >
    <title>{{title}}</title>
</head>
<body>
    {% module NavBar() %}

    <main>
        <h1>{{title}}</h1>
        <p>{{description}}</p>

        <div class="contents">
            {% module DisplayImage(image) %}

            <form id="form" class="box main-form" method="post" {% if parameters and "file" in {field["input"] for field in parameters} %}enctype="multipart/form-data"{% end %}>
                {% if parameters %}{% set existing_tags = {} %}
                {% for field in parameters %}
                <div class="form-item" id="item-{{field['name']}}">
                    <label for="{{field['name']}}" title="{{field['description']}}">{{field["label"]}}</label>
                    {% if field['input'] == "select" %}
                    <select name="{{field['name']}}" title="{{field['description']}}">
                    {% for option in (options.get(field['name']) or field['options']) %}
                        <option value="{{option or none}}" {% if existing.get(field["name"]) == option %}selected{% end %}>{{option}}</option>
                    {% end %}
                    </select>
                    {% elif field['input'] == "textarea" %}
                    <textarea class="text" name={{field['name']}} title="{{field['description']}}" rows=3>{{existing.get(field['name']) or ""}}</textarea>
                    {% elif field['input'] == "hidden" %}
                    <input type="text" name="{{field['name']}}" value="{{existing.get(field['name'])}}" hidden>
                    {% elif field['input'] == "tags" %}{% set existing_tags[field["name"]] = existing.get(field["name"], []) %}
                    <noscript><textarea name="{{field['name']}}-list">{{"\n".join((existing.get(field['name'])) or "")}}</textarea></noscript>
                    {% else %}
                    <input type="{{field['input']}}" name="{{field['name']}}" title="{{field['description']}}" {% if field["input"] != "checkbox" %} value="{{existing.get(field['name']) or ''}}"{% else %}class="text"{% end %}{% if field["required"] %} required{% end %}{% if field["input"] == "checkbox" %}{% if field['name'] in existing %}{% if existing.get(field['name']) %} checked{% end %}{% elif field.get("default") %} checked{% end %}{% end %}>
                    {% end %}
                </div>
                {% end%}
                {% end%}

                <input type="submit" value="{{submit}}">
            </form>
        </div>
    </main>
    {% if known_tags is not None %}
    <script type="text/javascript">
        const KNOWN_TAGS = {% raw json_encode(known_tags) %};
        const CURRENT_TAGS = {% raw json_encode(existing_tags) %};

        function setup_js() {
            form = document.getElementById("form");
            datalist = document.createElement("datalist");
            datalist.id = "known-tags";
            for (tag of KNOWN_TAGS) {
                option = document.createElement("option");
                option.setAttribute("value", tag);
                datalist.appendChild(option);
            }
            form.appendChild(datalist);

            for ([name, tags] of Object.entries(CURRENT_TAGS)) {
                div = document.getElementById("item-" + name);

                add_form = document.createElement("form");
                add_form.id = "add-tag-form-" + name;
                add_form.setAttribute("class", "tag-form")

                input = document.createElement("input");
                input.id = "add-tag-" + name;
                input.setAttribute("class", "add-text");
                input.setAttribute("form", add_form.id);
                input.setAttribute("type", "text");
                input.setAttribute("list", "known-tags");
                add_form.appendChild(input);

                button = document.createElement("input");
                button.setAttribute("class", "add-button")
                button.setAttribute("type", "submit");
                button.setAttribute("form", add_form.id);
                button.setAttribute("value", "add");
                add_form.appendChild(button);

                add_form.setAttribute("onsubmit", "return add_tag('" + name + "')");
                div.appendChild(add_form);

                select = document.createElement("select");
                select.id = name;
                select.setAttribute("name", name);
                select.setAttribute("multiple", true);

                for (tag of tags) {
                    option = document.createElement("option");
                    option.setAttribute("value", tag);
                    option.appendChild(document.createTextNode(tag));
                    select.appendChild(option);
                }

                div.appendChild(select);

                button = document.createElement("button");
                button.appendChild(document.createTextNode("remove"));
                button.setAttribute("type", "button");
                button.setAttribute("onclick", "remove_tag('" + name + "')");
                div.appendChild(button);
            }

            form.setAttribute("onsubmit", "return select_all()");
        }

        function add_tag(name) {
            input = document.getElementById("add-tag-" + name);
            select = document.getElementById(name);

            options = select.children;
            matching = false;
            for (i = 0; i < options.length; i++) {
                if (options[i].value == input.value) {
                    matching = true;
                    break;
                }
            }

            if (!matching) {
                option = document.createElement("option");
                option.setAttribute("value", input.value);
                option.appendChild(document.createTextNode(input.value));
                select.appendChild(option);
            }

            input.value = "";

            return false;
        }

        function remove_tag(name) {

            select = document.getElementById(name);

            options = select.children;
            for (i = 0; i < options.length; i++) {
                if (options[i].selected) {
                    options[i].remove();
                }
            }
        }

        function select_all() {
            for ([name, tags] of Object.entries(CURRENT_TAGS)) {
                select = document.getElementById(name);
                options = select.children;
                for (i = 0; i < options.length; i++) {
                    options[i].selected = true;
                }

                return true;
            }
        }

        window.addEventListener("DOMContentLoaded", setup_js);
    </script>
    {% end %}
</body>
</html>